<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hunter Check-in (Debug)</title>
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        :root { --primary: #06c755; --bg: #f2f3f5; --card: #ffffff; --text: #111; }
        body { margin: 0; padding: 20px; font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); }
        .container { max-width: 480px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .required::after { content: " *"; color: #ff3b30; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; background: #fafafa; }
        .btn-main { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .btn-main:disabled { background-color: #ccc; }
        .hidden { display: none; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h3 style="text-align:center; margin-bottom:20px;">üìç Hunter Check-in (Debug)</h3>
        
        <div class="card">
            <form id="checkinForm" onsubmit="submitForm(event)">
                <div class="form-group">
                    <label class="form-label required">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö</label>
                    <input type="text" id="topic" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="visitType" onchange="toggleLeadOptions()" required>
                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="Existing">ü§ù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°</option>
                        <option value="New Customer">üöÄ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏õ‡∏¥‡∏î Lead)</option>
                    </select>
                </div>
                <div id="leadSection" class="hidden" style="background:#f0f9ff; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid #bce3ff;">
                    <div class="form-group">
                        <label class="form-label required">Job Type</label>
                        <select id="salesType">
                            <option value="Type 1">Type 1: ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ</option>
                            <option value="Type 2">Type 2: ‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡πà‡∏ô</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="estValue">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label>
                    <input type="text" id="gpsDisplay" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." readonly style="background:#eee; color:#555;">
                    <input type="hidden" id="lat"><input type="hidden" id="long">
                </div>
                <div class="form-group">
                    <label class="form-label required">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</label>
                    <input type="file" id="photo" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea id="note" rows="2"></textarea>
                </div>
                <button type="submit" id="submitBtn" class="btn-main">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ</button>
            </form>
        </div>
    </div>

    <div id="loading" class="overlay hidden">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-weight:bold;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <p id="debugText" style="color:red; font-size:12px; margin-top:5px;">State: Init</p>
    </div>

    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ==========================================
        // üö® ‡πÅ‡∏Å‡πâ URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üö®
        const N8N_WEBHOOK_URL = "https://n8npkapp.pktechnic.com/webhook/hunter-checkin"; 
        const LIFF_ID = "2008824673-BnxO2I7Y";
        // ==========================================

        let hunterProfileName = "Unknown";

        window.onload = function() {
            logDebug("Loading GPS...");
            getGPS();
            initializeLiff(LIFF_ID);
        };

        function logDebug(msg) {
            console.log(msg);
            document.getElementById("debugText").innerText = msg;
        }

        function initializeLiff(id) {
            liff.init({ liffId: id }).then(() => {
                if (liff.isLoggedIn()) {
                    liff.getProfile().then(profile => {
                        hunterProfileName = profile.displayName;
                        logDebug("LIFF Logged in: " + hunterProfileName);
                    });
                } else {
                    liff.login();
                }
            });
        }

        function getGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    document.getElementById("lat").value = pos.coords.latitude;
                    document.getElementById("long").value = pos.coords.longitude;
                    document.getElementById("gpsDisplay").value = "‚úÖ " + pos.coords.latitude.toFixed(5) + ", " + pos.coords.longitude.toFixed(5);
                    logDebug("GPS Found!");
                }, (err) => {
                    document.getElementById("gpsDisplay").value = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î";
                    logDebug("GPS Error: " + err.message);
                    alert("GPS Error: " + err.message);
                }, {enableHighAccuracy: true});
            } else {
                alert("Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
            }
        }

        function toggleLeadOptions() {
            const isNew = document.getElementById("visitType").value === "New Customer";
            document.getElementById("leadSection").style.display = isNew ? "block" : "none";
            document.getElementById("salesType").required = isNew;
        }

        function submitForm(e) {
            e.preventDefault();
            
            // 1. ‡πÄ‡∏ä‡πá‡∏Ñ GPS
            if(!document.getElementById("lat").value) { 
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); 
                getGPS(); 
                return; 
            }

            // 2. ‡πÄ‡∏ä‡πá‡∏Ñ URL
            if(N8N_WEBHOOK_URL.includes("your-n8n-instance")) {
                alert("üö® ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ URL ‡∏Ç‡∏≠‡∏á n8n ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ñ‡∏£‡∏±‡∏ö!");
                return;
            }

            document.getElementById("loading").classList.remove("hidden");
            document.getElementById("submitBtn").disabled = true;
            logDebug("Processing Image...");

            const file = document.getElementById('photo').files[0];
            const reader = new FileReader();
            
            reader.readAsDataURL(file);
            reader.onload = function(evt) {
                const img = new Image();
                img.src = evt.target.result;
                img.onload = function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const maxW = 800;
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const payload = {
                        hunterName: hunterProfileName,
                        clientName: document.getElementById("clientName").value,
                        topic: document.getElementById("topic").value,
                        visitType: document.getElementById("visitType").value,
                        salesType: document.getElementById("visitType").value === "New Customer" ? document.getElementById("salesType").value : "",
                        estValue: document.getElementById("estValue").value,
                        lat: document.getElementById("lat").value,
                        long: document.getElementById("long").value,
                        note: document.getElementById("note").value,
                        image: canvas.toDataURL("image/jpeg", 0.6)
                    };

                    logDebug("Sending to n8n...");
                    alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ó‡∏µ‡πà: " + N8N_WEBHOOK_URL + "\n(‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á)");

                    fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        logDebug("Response Status: " + response.status);
                        if (!response.ok) {
                            throw new Error("HTTP error! status: " + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                        liff.closeWindow();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        logDebug("Error: " + error.message);
                        alert("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + error.message + "\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n1. URL n8n ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HTTPS\n2. ‡∏ï‡∏¥‡∏î CORS (‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà n8n)\n3. URL ‡∏ú‡∏¥‡∏î");
                        document.getElementById("loading").classList.add("hidden");
                        document.getElementById("submitBtn").disabled = false;
                    });
                }
            }
        }
    </script>
</body>
</html>
