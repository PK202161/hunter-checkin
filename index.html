<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hunter Check-in</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        :root { 
            --primary: #06c755;
            --primary-dark: #05a647;
            --bg: #f2f3f5;
            --card-bg: #ffffff;
            --text: #111111;
            --text-light: #666666;
            --border: #e0e0e0;
            --error: #ff3b30;
            --success: #34c759;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { 
            max-width: 480px; 
            margin: 0 auto; 
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .header .user-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .card { 
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-label { 
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
        }
        
        .required::after { 
            content: " *";
            color: var(--error);
        }
        
        input, select, textarea { 
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: var(--text);
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        input::placeholder, textarea::placeholder {
            color: #999;
        }
        
        input[readonly] {
            background: #f5f5f5;
            color: var(--text-light);
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath fill='%23666' d='M0 0l6 8 6-8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn-main { 
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-main:active {
            transform: scale(0.98);
            background: var(--primary-dark);
        }
        
        .btn-main:disabled { 
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .lead-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #bae6fd;
            margin-bottom: 20px;
        }
        
        .lead-section h3 {
            font-size: 15px;
            color: #0369a1;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .gps-display {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .gps-display input {
            flex: 1;
        }
        
        .gps-refresh {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .gps-refresh:active {
            background: var(--bg);
        }
        
        .hidden { 
            display: none !important; 
        }
        
        .overlay { 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .spinner { 
            width: 50px;
            height: 50px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        .loading-status {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-light);
        }
        
        /* Success checkmark animation */
        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: white;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* File input styling */
        input[type="file"]::file-selector-button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-right: 12px;
        }
        
        input[type="file"]::file-selector-button:active {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìç Hunter Check-in</h1>
            <div class="user-badge" id="userBadge">
                <span id="userName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
            </div>
        </div>

        <div class="card">
            <form id="checkinForm" onsubmit="submitForm(event)">
                <div class="form-group">
                    <label class="form-label required">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                    <input type="text" id="clientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö</label>
                    <input type="text" id="topic" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                    <select id="visitType" onchange="toggleLeadOptions()" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ --</option>
                        <option value="Existing">ü§ù ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏° (Follow up)</option>
                        <option value="New Customer">‚ú® ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏õ‡∏¥‡∏î Lead)</option>
                    </select>
                </div>
                
                <div id="leadSection" class="lead-section hidden">
                    <h3>üöÄ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Deal ‡πÉ‡∏´‡∏°‡πà</h3>
                    <div class="form-group">
                        <label class="form-label required">Job Type</label>
                        <select id="salesType">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
                            <option value="Type 1">Type 1: ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏õ</option>
                            <option value="Type 2">Type 2: ‡∏á‡∏≤‡∏ô‡πÇ‡∏ã‡∏•‡∏π‡∏ä‡∏±‡πà‡∏ô</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ Deal (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="estValue" placeholder="0" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS</label>
                    <div class="gps-display">
                        <input type="text" id="gpsDisplay" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." readonly>
                        <button type="button" class="gps-refresh" onclick="getGPS()" title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä GPS">
                            üîÑ
                        </button>
                    </div>
                    <input type="hidden" id="lat">
                    <input type="hidden" id="long">
                </div>
                
                <div class="form-group">
                    <label class="form-label required">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢</label>
                    <input type="file" id="photo" accept="image/*" capture="environment" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>
                
                <button type="submit" id="submitBtn" class="btn-main">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ
                </button>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="overlay hidden">
        <div class="spinner"></div>
        <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        <p class="loading-status" id="loadingStatus">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // ==========================================
        // üîß Configuration
        // ==========================================
        const N8N_WEBHOOK_URL = "https://n8npkapp.pktechnic.com/webhook/hunter-checkin";
        const LIFF_ID = "2008824673-BnxO2I7Y";
        
        let hunterProfileName = "Unknown";

        // ==========================================
        // üöÄ Initialize
        // ==========================================
        window.onload = function() {
            getGPS();
            initializeLiff(LIFF_ID);
        };

        // ==========================================
        // üîê LIFF Authentication
        // ==========================================
        function initializeLiff(id) {
            if (typeof liff === 'undefined') {
                alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE app");
                return;
            }

            liff.init({ liffId: id })
                .then(() => {
                    if (!liff.isInClient()) {
                        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô LINE app\n\n‡∏™‡πà‡∏á URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô LINE:\nhttps://liff.line.me/" + LIFF_ID);
                        return;
                    }
                    
                    if (liff.isLoggedIn()) {
                        return liff.getProfile();
                    } else {
                        liff.login();
                        return null;
                    }
                })
                .then(profile => {
                    if (profile) {
                        hunterProfileName = profile.displayName;
                        document.getElementById('userName').innerText = hunterProfileName;
                    }
                })
                .catch(err => {
                    console.error('LIFF Error:', err);
                    alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                });
        }

        // ==========================================
        // üìç GPS Functions
        // ==========================================
        function getGPS() {
            const gpsDisplay = document.getElementById("gpsDisplay");
            gpsDisplay.value = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            
            if (!navigator.geolocation) {
                gpsDisplay.value = "‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
                return;
            }

            navigator.geolocation.getCurrentPosition(
                pos => {
                    document.getElementById("lat").value = pos.coords.latitude;
                    document.getElementById("long").value = pos.coords.longitude;
                    gpsDisplay.value = `${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                },
                err => {
                    console.error('GPS Error:', err);
                    gpsDisplay.value = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î";
                    alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡πÑ‡∏î‡πâ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤:\n1. ‡πÄ‡∏õ‡∏¥‡∏î Location Services\n2. ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á\n3. ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° üîÑ ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 10000, 
                    maximumAge: 0 
                }
            );
        }

        // ==========================================
        // üìù Form Functions
        // ==========================================
        function toggleLeadOptions() {
            const visitType = document.getElementById("visitType").value;
            const section = document.getElementById("leadSection");
            const salesType = document.getElementById("salesType");
            
            if (visitType === "New Customer") {
                section.classList.remove("hidden");
                salesType.required = true;
            } else {
                section.classList.add("hidden");
                salesType.required = false;
                salesType.value = "";
                document.getElementById("estValue").value = "";
            }
        }

        // ==========================================
        // üì§ Submit Form
        // ==========================================
        async function submitForm(e) {
            e.preventDefault();
            
            // Validate GPS
            if (!document.getElementById("lat").value) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS");
                getGPS();
                return;
            }

            // Validate photo
            const photoFile = document.getElementById('photo').files[0];
            if (!photoFile) {
                alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢");
                return;
            }

            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...");

            try {
                // Process image
                const imageBase64 = await processImage(photoFile);
                
                // Prepare payload
                const payload = {
                    hunterName: hunterProfileName,
                    clientName: document.getElementById("clientName").value.trim(),
                    topic: document.getElementById("topic").value.trim(),
                    visitType: document.getElementById("visitType").value,
                    salesType: document.getElementById("visitType").value === "New Customer" ? 
                               document.getElementById("salesType").value : "",
                    estValue: document.getElementById("estValue").value || "",
                    lat: document.getElementById("lat").value,
                    long: document.getElementById("long").value,
                    note: document.getElementById("note").value.trim(),
                    image: imageBase64
                };

                showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");

                // Send to N8N with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: ${response.status}`);
                }

                const result = await response.json();
                
                // Show success
                showSuccess();
                
                // Close after delay
                setTimeout(() => {
                    if (typeof liff !== 'undefined' && liff.isInClient()) {
                        liff.closeWindow();
                    } else {
                        hideLoading();
                        // Reset form
                        document.getElementById("checkinForm").reset();
                        getGPS();
                    }
                }, 2000);

            } catch (error) {
                hideLoading();
                
                let errorMsg = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                
                if (error.name === 'AbortError') {
                    errorMsg = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤: ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                } else {
                    errorMsg = error.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
                }
                
                alert("‚ùå " + errorMsg);
                console.error('Submit Error:', error);
            }
        }

        // ==========================================
        // üñºÔ∏è Image Processing
        // ==========================================
        function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        
                        // Resize to max 800px width
                        const maxWidth = 800;
                        const scale = Math.min(1, maxWidth / img.width);
                        
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Convert to JPEG with 60% quality
                        resolve(canvas.toDataURL("image/jpeg", 0.6));
                    };
                    
                    img.onerror = () => reject(new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ"));
                };
                
                reader.onerror = () => reject(new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ"));
                reader.readAsDataURL(file);
            });
        }

        // ==========================================
        // üé® UI Functions
        // ==========================================
        function showLoading(message) {
            document.getElementById("loadingStatus").innerText = message;
            document.getElementById("loading").classList.remove("hidden");
            document.getElementById("submitBtn").disabled = true;
        }

        function hideLoading() {
            document.getElementById("loading").classList.add("hidden");
            document.getElementById("submitBtn").disabled = false;
        }

        function showSuccess() {
            const loading = document.getElementById("loading");
            loading.innerHTML = `
                <div class="success-icon">‚úì</div>
                <p class="loading-text" style="color: var(--success);">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
                <p class="loading-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á...</p>
            `;
        }
    </script>
</body>
</html>
